pipeline{
    agent{
        kubernetes{
            label 'aws-infra-builder'
            defaultContainer 'jnlp'
            yaml '''
apiVersion: v1
kind: Pod
metadata:
    labels:
    agent: agent-pod
spec:
    containers:
    - name: terraform-aws-cli
      image: arunareath/terraform-aws-cli:latest
      command:
      - cat
      tty: true
    - name: jnlp
      image: jenkins/inbound-agent:4.13-1
      args: ['$(JENKINS_SECRET)', '$(JENKINS_NAME)']
    - name: git
      image: alpine/git
      command: ['cat']
      tty: true
    serviceAccountName: jenkins
'''
        }
    }

    stages{
        stage('Checkout'){
            steps{
                script {
                        // Use the configured Git tool explicitly
                        def gitTool = tool name: 'git', type: 'hudson.plugins.git.GitTool'
                        withEnv(["GIT_HOME=${gitTool}/bin"]) {
                            git url: 'https://github.com/Arunareath/AWS-Jenkins-Gov.git', credentialsId: 'github-credentials'
                    }{
                        sh '''
                            ls -ltra "/home/jenkins/agent/workspace/AWS-Pipeline"
                        '''
                    }
                }
            }
        }

        stage('AWS Credentials'){

            steps{
                script {
                    withCredentails([
                        [$class: 'AmazonWebServicesCredentialsBinding', credentialId: '247828134926']
                    ]){
                        sh '''
                            export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
                            export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
                            export AWS_REGION=us-gov-west-1
                        '''
                    }
                }
            }

        }

        stage('terraform init'){
            steps{
                container('terraform-aws-cli'){
                    sh 'terraform init'
                }
            }
        }

        stage('terraform plan'){
            steps{
                container('terraform-aws-cli'){
                    sh 'terraform plan'
                }
            }
        }

        stage('terraform apply'){
            steps{
                container('terraform-aws-cli'){
                    sh 'terraform apply -auto-approve'
                }
            }
        }
    }

}