pipeline{
    agent{
        kubernetes{
            label 'aws-infra-builder'
            defaultContainer 'jnlp'
            yaml '''
apiVersion: v1
kind: Pod
metadata:
    labels:
    agent: agent-pod
spec:
    containers:
    - name: terraform-aws-cli
      image: arunareath/terraform-aws-cli:latest
      command:
      - cat
      tty: true
    - name: jnlp
      image: jenkins/inbound-agent:4.13-1
      args: ['$(JENKINS_SECRET)', '$(JENKINS_NAME)']
    serviceAccountName: jenkins
'''
        }
    }
    
    environment {
        // Set the path to Git executable explicitly
        GIT_HOME = '/usr/bin/git'
    }

    stages{
        stage('Checkout'){
            steps{
                container('terraform-aws-cli'){
                    git clone "https://github.com/Arunareath/AWS-Jenkins-Gov.git"
                }
            }
        }

        stage('AWS Credentials'){

            steps{
                script {
                    withCredentails([
                        [$class: 'AmazonWebServicesCredentialsBinding', credentialId: '247828134926']
                    ]){
                        sh '''
                            export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
                            export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
                            export AWS_REGION=us-gov-west-1
                        '''
                    }
                }
            }

        }

        stage('terraform init'){
            steps{
                container('terraform-aws-cli'){
                    sh 'terraform init'
                }
            }
        }

        stage('terraform plan'){
            steps{
                container('terraform-aws-cli'){
                    sh 'terraform plan'
                }
            }
        }

        stage('terraform apply'){
            steps{
                container('terraform-aws-cli'){
                    sh 'terraform apply -auto-approve'
                }
            }
        }
    }

}